/**
 * Scoring Predictions Table
 *
 * Stores all market predictions generated by the scoring system
 * Each row represents one market prediction for one match
 *
 * @version 1.0.0
 * @date 2026-01-28
 */

-- Drop existing table if exists (for development only)
DROP TABLE IF EXISTS scoring_predictions CASCADE;

-- Create scoring_predictions table
CREATE TABLE scoring_predictions (
  -- Primary key
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Match identifiers
  match_id VARCHAR(50) NOT NULL,                    -- TheSports external_id (alphanumeric)
  fs_match_id INTEGER NOT NULL,                     -- FootyStats numeric ID
  market_id VARCHAR(20) NOT NULL,                   -- O25, BTTS, HT_O05, etc.
  market_name VARCHAR(100) NOT NULL,                -- Display name (Turkish)

  -- Core scoring results
  probability DECIMAL(6,4) NOT NULL,                -- 0.0000 - 1.0000 (e.g., 0.6850 = 68.5%)
  confidence INTEGER NOT NULL CHECK (confidence >= 0 AND confidence <= 100),
  pick VARCHAR(3) NOT NULL CHECK (pick IN ('YES', 'NO')),
  edge DECIMAL(6,4),                                -- Expected value edge (can be NULL if no odds)

  -- Transparency (JSONB for component breakdown)
  components JSONB NOT NULL,                        -- Array of ComponentResult objects
  risk_flags TEXT[] DEFAULT '{}',                   -- Array of risk flag strings
  data_score INTEGER NOT NULL CHECK (data_score >= 0 AND data_score <= 100),

  -- Settlement (filled after match ends)
  settled BOOLEAN DEFAULT FALSE,
  settlement_result VARCHAR(10) CHECK (settlement_result IN ('WIN', 'LOSS', 'VOID')),
  settlement_actual_value JSONB,                    -- Actual match stats (goals, corners, etc.)
  settled_at TIMESTAMPTZ,

  -- Metadata
  scored_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Constraints
  CONSTRAINT unique_prediction UNIQUE (match_id, market_id)
);

-- Indexes for performance
CREATE INDEX idx_scoring_predictions_match_id ON scoring_predictions(match_id);
CREATE INDEX idx_scoring_predictions_market_id ON scoring_predictions(market_id);
CREATE INDEX idx_scoring_predictions_pick ON scoring_predictions(pick);
CREATE INDEX idx_scoring_predictions_settled ON scoring_predictions(settled);
CREATE INDEX idx_scoring_predictions_scored_at ON scoring_predictions(scored_at DESC);

-- Composite index for daily list generation
CREATE INDEX idx_scoring_predictions_daily_list ON scoring_predictions(market_id, pick, confidence DESC, probability DESC)
  WHERE settled = FALSE;

-- Composite index for settlement
CREATE INDEX idx_scoring_predictions_settlement ON scoring_predictions(match_id, settled)
  WHERE settled = FALSE;

-- GIN index for JSONB queries (component search)
CREATE INDEX idx_scoring_predictions_components ON scoring_predictions USING GIN(components);

-- Trigger to update updated_at
CREATE OR REPLACE FUNCTION update_scoring_predictions_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_scoring_predictions_updated_at
  BEFORE UPDATE ON scoring_predictions
  FOR EACH ROW
  EXECUTE FUNCTION update_scoring_predictions_updated_at();

-- Comments for documentation
COMMENT ON TABLE scoring_predictions IS 'Stores all market predictions generated by the scoring system';
COMMENT ON COLUMN scoring_predictions.match_id IS 'TheSports external_id (alphanumeric, e.g., l7oqdehg6ko3r51)';
COMMENT ON COLUMN scoring_predictions.fs_match_id IS 'FootyStats numeric ID';
COMMENT ON COLUMN scoring_predictions.market_id IS 'Market identifier (O25, BTTS, HT_O05, O35, HOME_O15, CORNERS_O85, CARDS_O25)';
COMMENT ON COLUMN scoring_predictions.probability IS 'Calculated probability (0.0000 - 1.0000)';
COMMENT ON COLUMN scoring_predictions.confidence IS 'Confidence score (0 - 100)';
COMMENT ON COLUMN scoring_predictions.pick IS 'YES or NO based on thresholds';
COMMENT ON COLUMN scoring_predictions.edge IS 'Expected value edge vs odds';
COMMENT ON COLUMN scoring_predictions.components IS 'JSONB array of component breakdown for transparency';
COMMENT ON COLUMN scoring_predictions.risk_flags IS 'Array of risk flags (MISSING_XG, HIGH_VARIANCE, etc.)';
COMMENT ON COLUMN scoring_predictions.data_score IS 'Data completeness score (0-100)';
COMMENT ON COLUMN scoring_predictions.settled IS 'Whether prediction has been settled';
COMMENT ON COLUMN scoring_predictions.settlement_result IS 'WIN, LOSS, or VOID';
COMMENT ON COLUMN scoring_predictions.settlement_actual_value IS 'Actual match stats for settlement';

-- Sample data structure for components JSONB
COMMENT ON COLUMN scoring_predictions.components IS 'Example: [{"name": "prior_probability", "weight": 0.25, "raw_value": 68, "weighted_contribution": 0.17, "is_available": true, "data_source": "footystats.potentials.over25"}]';

-- Grant permissions (adjust based on your user)
-- GRANT SELECT, INSERT, UPDATE ON scoring_predictions TO goalgpt_api;
-- GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO goalgpt_api;

-- Success message
SELECT 'scoring_predictions table created successfully' AS status;
