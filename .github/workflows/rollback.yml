name: Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - 'staging'
          - 'production'
      confirm:
        description: 'Type "ROLLBACK" to confirm'
        required: true

jobs:
  validate-rollback:
    name: Validate Rollback Request
    runs-on: ubuntu-latest
    steps:
      - name: ‚úÖ Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "ROLLBACK" ]; then
            echo "‚ùå Confirmation failed. You must type 'ROLLBACK' to proceed."
            exit 1
          fi
          echo "‚ö†Ô∏è  ROLLBACK CONFIRMED - Proceeding with emergency rollback"

  rollback:
    name: Execute Rollback
    runs-on: ubuntu-latest
    needs: validate-rollback

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîÑ Rollback Staging
        if: github.event.inputs.environment == 'staging'
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_KEY: ${{ secrets.STAGING_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$STAGING_KEY" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/staging_key
          ssh-keyscan -H $STAGING_HOST >> ~/.ssh/known_hosts

          echo "üîÑ Starting emergency rollback..."

          ssh -i ~/.ssh/staging_key $STAGING_USER@$STAGING_HOST << 'EOF'
            set -e
            cd /var/www/goalgpt

            echo "‚ö†Ô∏è  DISABLING ALL OPTIMIZATIONS..."

            # Disable all feature flags
            export USE_OPTIMIZED_DAILY_REWARDS=false
            export USE_OPTIMIZED_BADGE_UNLOCK=false
            export USE_OPTIMIZED_SCHEDULED_NOTIFICATIONS=false
            export USE_OPTIMIZED_PUSH_SERVICE=false

            # Reset concurrency limits
            export MATCH_ENRICHER_CONCURRENCY=999
            export MATCH_WATCHDOG_CONCURRENCY=999
            export BADGE_AUTO_UNLOCK_BATCH_SIZE=1

            # Disable caching
            export USE_REDIS_CACHE=false
            export CACHE_STANDINGS=false
            export CACHE_H2H=false
            export CACHE_MATCH_DETAILS=false

            echo "üîÑ Restarting application..."
            pm2 restart goalgpt-api

            echo "‚è≥ Waiting 10 seconds for restart..."
            sleep 10

            echo "‚úÖ Verifying application health..."
            curl -f http://localhost:3000/health || exit 1

            echo "‚úÖ ROLLBACK COMPLETED (30 seconds)"
            echo "üìä All optimizations disabled"
            echo "üìä Application is healthy"
          EOF

      - name: üîÑ Rollback Production
        if: github.event.inputs.environment == 'production'
        env:
          PRODUCTION_HOST: ${{ secrets.PRODUCTION_HOST }}
          PRODUCTION_USER: ${{ secrets.PRODUCTION_USER }}
          PRODUCTION_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$PRODUCTION_KEY" > ~/.ssh/prod_key
          chmod 600 ~/.ssh/prod_key
          ssh-keyscan -H $PRODUCTION_HOST >> ~/.ssh/known_hosts

          echo "‚ö†Ô∏è  Starting PRODUCTION emergency rollback..."

          ssh -i ~/.ssh/prod_key $PRODUCTION_USER@$PRODUCTION_HOST << 'EOF'
            set -e
            cd /var/www/goalgpt

            echo "‚ö†Ô∏è  DISABLING ALL OPTIMIZATIONS..."

            # Disable all feature flags
            export USE_OPTIMIZED_DAILY_REWARDS=false
            export USE_OPTIMIZED_BADGE_UNLOCK=false
            export USE_OPTIMIZED_SCHEDULED_NOTIFICATIONS=false
            export USE_OPTIMIZED_PUSH_SERVICE=false

            # Reset concurrency limits
            export MATCH_ENRICHER_CONCURRENCY=999
            export MATCH_WATCHDOG_CONCURRENCY=999
            export BADGE_AUTO_UNLOCK_BATCH_SIZE=1

            # Disable caching
            export USE_REDIS_CACHE=false
            export CACHE_STANDINGS=false
            export CACHE_H2H=false
            export CACHE_MATCH_DETAILS=false

            echo "üîÑ Restarting application..."
            pm2 restart goalgpt-api

            echo "‚è≥ Waiting 10 seconds for restart..."
            sleep 10

            echo "‚úÖ Verifying application health..."
            curl -f http://localhost:3000/health || exit 1

            echo "‚úÖ PRODUCTION ROLLBACK COMPLETED (30 seconds)"
            echo "üìä All optimizations disabled"
            echo "üìä Application is healthy"
            echo "‚ö†Ô∏è  INVESTIGATE: Check logs for errors"
          EOF

      - name: üìä Post-rollback status
        env:
          TARGET_HOST: ${{ github.event.inputs.environment == 'staging' && secrets.STAGING_HOST || secrets.PRODUCTION_HOST }}
          TARGET_USER: ${{ github.event.inputs.environment == 'staging' && secrets.STAGING_USER || secrets.PRODUCTION_USER }}
          TARGET_KEY: ${{ github.event.inputs.environment == 'staging' && secrets.STAGING_SSH_KEY || secrets.PRODUCTION_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$TARGET_KEY" > ~/.ssh/key
          chmod 600 ~/.ssh/key

          ssh -i ~/.ssh/key $TARGET_USER@$TARGET_HOST << 'EOF'
            cd /var/www/goalgpt
            ./scripts/deploy-status.sh
          EOF

      - name: üìä Generate rollback report
        if: always()
        run: |
          echo "## Emergency Rollback Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Rollback completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions Taken" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå Disabled all PR-P1B optimizations" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå Reset PR-P1C concurrency limits" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå Disabled PR-P1D caching" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Restarted application" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Verified health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Check logs: \`tail -100 logs/error.log\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Investigate root cause" >> $GITHUB_STEP_SUMMARY
          echo "3. Fix issues" >> $GITHUB_STEP_SUMMARY
          echo "4. Re-deploy when ready" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: rollback
    if: always()

    steps:
      - name: üîî Create incident issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Emergency Rollback - ${{ github.event.inputs.environment }}`,
              body: `## Emergency Rollback Executed

**Environment**: ${{ github.event.inputs.environment }}
**Date**: ${new Date().toISOString()}
**Triggered By**: @${{ github.actor }}
**Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

### Status
‚úÖ Rollback completed successfully

### Actions Taken
- Disabled all optimizations
- Reset concurrency limits
- Disabled caching
- Restarted application
- Verified health

### Next Steps
1. [ ] Check logs for errors
2. [ ] Investigate root cause
3. [ ] Document incident
4. [ ] Fix issues
5. [ ] Re-deploy when ready

### Logs
Check logs on server:
\`\`\`bash
ssh root@${{ github.event.inputs.environment }}.goalgpt.com
cd /var/www/goalgpt
tail -100 logs/error.log
\`\`\`

---
**Auto-generated by Emergency Rollback workflow**
              `,
              labels: ['incident', 'rollback', 'urgent']
            });

            console.log(`Created issue #${issue.data.number}`);
